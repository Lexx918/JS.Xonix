<script>function a(){X=Y=1,U=$.getImageData(8,8,8,8)}function b(b){for(q(F),$.fillRect(0,0,640,384),q(B),$.fillRect(16,16,608,352),a(),x=W;x--;)for(y=H;y--;)_[[x,y]]=x>1&&78>x&&y>1&&46>y?B:F;for(E=[],i=b;i--;)E.push({x:3+d(70),y:3+d(40),v:d(3)})}function c(){if(!--D)return alert("Game over!");for(M--,o(X,Y,B),y=2;46>y;y++)for(x=2;78>x;x++)_[[x,y]]==K&&o(x,y,B);a(),setTimeout(g,900)}function d(a){return~~(Math.random()*++a)}function g(){for(i=E.length;i--;){if(e=E[i],x=e.x,y=e.y,v=e.v%4,Z=[y?[x,y-1]:0,w>x&&y?[x+1,y-1]:0,w>x?[x+1,y]:0,w>x&&h>y?[x+1,y+1]:0,h>y?[x,y+1]:0,x&&h>y?[x-1,y+1]:0,x?[x-1,y]:0,x&&y?[x-1,y-1]:0],k=2*v,l=Z[k++],f=Z[k++],r=Z[k%8],_[l]==K||_[f]==K||_[r]==K)return c();l=_[l]!=B,f=_[f]!=B,r=_[r]!=B,l||f||r?e.v=v+1+(f&&l==r)+2*(r&&!l):(o(x,y,B),e.x+=2>v?1:-1,e.y+=v%3?1:-1,o(e.x,e.y,N))}if(M){if($.putImageData(U,8*X,8*Y),n(U,B)&&o(X,Y,K),!V&&X&&X--,1==V&&Y&&Y--,2==V&&w>X&&X++,V>2&&h>Y&&Y++,u=$.getImageData(8*X,8*Y,8,8),n(u,K))return c();n(U,B)&&n(u,F)&&t(M--),U=u}return q(B),$.fillRect(0,384,640,16),o(X,Y,"168,168,168"),$.fillText("Score: "+(T+P),0,399),$.fillText("Xn: "+D,224,399),p=100*P/3344,$.fillText("Full: "+~~p+"%",322,399),p>75?(T+=P,P=0,b(E.length+1),setTimeout(g,900),void 0):(setTimeout(g,40),void 0)}function n(a,b){return(a=a.data)&&""+a[0]+","+a[1]+","+a[2]==b}function o(a,b,c){q(c),$.fillRect(8*a,8*b,8,8),_[[a,b]]=c}function q(a){$.fillStyle="rgb("+a+")"}function t(){for(A=[],y=2;46>y;y++)for(x=2;78>x;x++)k=_[[x,y]],k==K&&(o(x,y,F),P++),k==B&&(P+=s=C(x,y,"1"),A.push([x,y,s]));for(i=A.length;i--;)j=A[i],C(j[0],j[1],j[2]?F:B)}function C(a,b,c){for(k=_[[a,b]],f=[a,b],s=m=0;b=f.pop();)a=f.pop(),r=_[[a,b]],m+=e=r==N,(r==k||e)&&(o(a,b,c),s++,f.push(a-1,b,a,b-1,a+1,b,a,b+1));return m?0:s}W=80,H=48,w=79,h=47,_=[],X=Y=V=M=U=T=P=p=D=$=E=0,B="0,0,0",F="0,168,168",K="168,0,168",N="168,0,0",onkeyup=function(a){V=a.which%37%4,!M&&(!V&&X||1==V&&Y||2==V&&w>X||V>2&&h>Y)&&M++,$||($=z.getContext("2d"),$.font="20px TrueType",b(2),D=3,setTimeout(g,50))}</script><body><canvas id=z width=640 height=400>